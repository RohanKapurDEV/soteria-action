name: Soteria Scan
description: >
  Test Solana smart contract code for common vulnerabilities
branding:
  icon: truck
  color: green
inputs:
  solanaVersion:
    description: "Choose your Solana version to build with"
    required: false
    default: "1.9.4"
  options:
    description: "Command line options for Soteria"
    required: false
    default: "-analyzeAll"
  buildCommand:
    description: "Build command shortcut for: cargo +bpf build --target bpfel-unknown-unknown --release"
    required: false
    default: "."
  neverFail:
    description: "Configure the job to pass even if potential vulnerabilities are discovered"
    required: false
    default: "1"

runs:
  using: composite
  steps:
    - run: | 
        echo Installing Solana v${{ inputs.solanaVersion }}
        sh -c "$(curl -sSfL https://release.solana.com/v${{ inputs.solanaVersion }}/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="/home/runner/.local/share/solana/install/active_release/bin:$PATH"
        echo Installing bpf SDK...
        cargo build-bpf
        solana-keygen new -o "$HOME/.config/solana/id.json" --no-passphrase --silent
      shell: bash
    - run: | 
        echo Installing Soteria...
        sh -c "$(curl -k https://supercompiler.xyz/install)"
        export PATH=$PWD/soteria-linux-develop/bin/:$PATH
        echo "$PWD/soteria-linux-develop/bin" >> $GITHUB_PATH
      shell: bash
    - run: |
        soteria ${{ inputs.options }} ${{ inputs.buildCommand }} -raceLimit:30
      shell: bash
    - run: |
        cd soteria-linux-develop
        cd conf
        cat coderrect.json
      shell: bash
    - run: |
        echo Checking scan results...
        if grep -q "No vulnerabilities detected"; then
          echo The job passed as no vulnerabilities were found
          exit 0
        else
          echo The job failed as potential vulnerabilities were found
          echo If you configured the job to never fail, you may see this message while the job still passed
          exit ${{ inputs.neverFail }}
        fi
      shell: bash
